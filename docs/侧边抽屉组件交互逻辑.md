# 侧边抽屉组件交互逻辑说明

## 概述

侧边抽屉组件 (`SideDrawer.vue`) 是一个通用的弹出容器，从页面右侧滑出，用于承载表单等内容。本文档详细说明其调用和关闭的完整流程。

---

## 组件结构

```
SideDrawer.vue (通用抽屉容器)
├── 遮罩层 (drawer-overlay) - 点击可关闭
└── 抽屉容器 (drawer-container)
    ├── 头部 (drawer-header)
    │   ├── 标题
    │   └── 关闭按钮 (×) - 点击可关闭
    └── 内容区 (drawer-body)
        └── <slot> - 插槽，放置表单等组件
```

---

## 数据流向

```
┌─────────────────┐                    ┌─────────────────┐
│  父组件 (View)   │                    │ SideDrawer.vue  │
│                 │                    │                 │
│ drawerOpen: Ref │◄─── v-model ───────│ modelValue: Prop│
│    (bool)       │    emit            │    (bool)       │
└─────────────────┘                    └─────────────────┘
```

---

## 打开抽屉流程

### 用户操作：点击"添加XX"按钮

```
用户点击按钮
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ CropsView.vue / AnimalsView.vue / FlowersView.vue           │
├─────────────────────────────────────────────────────────────┤
│ <button @click="drawerOpen = true">添加粮食</button>         │
│                                                             │
│ const drawerOpen = ref(false)  // false → true             │
└─────────────────────────────────────────────────────────────┘
    │
    │ v-model 双向绑定
    ▼
┌─────────────────────────────────────────────────────────────┐
│ SideDrawer.vue                                              │
├─────────────────────────────────────────────────────────────┤
│ defineProps<{ modelValue: boolean }>()                     │
│                                                             │
│ 接收 modelValue = true                                      │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 条件渲染触发                                                │
├─────────────────────────────────────────────────────────────┤
│ <div v-if="modelValue" class="drawer-overlay">             │
│   <!-- 遮罩层和抽屉开始渲染 -->                              │
│                                                             │
│   <div class="drawer-container" :class="{ 'drawer-open' }"> │
│     <!-- CSS 类 drawer-open 被添加 -->                       │
│     <!-- transform: translateX(100%) → translateX(0) -->    │
│     <!-- 动画：300ms ease 向右滑出 -->                       │
│   </div>                                                    │
│ </div>                                                      │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 用户看到抽屉从右侧滑出                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 关闭抽屉流程

### 方式一：点击遮罩层

```
用户点击遮罩层
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ SideDrawer.vue                                              │
├─────────────────────────────────────────────────────────────┤
│ <div class="drawer-overlay" @click="close">                 │
│                                                             │
│ function close() {                                          │
│   emit('update:modelValue', false)  // 发出事件            │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
    │
    │ emit('update:modelValue', false)
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 父组件接收事件                                               │
├─────────────────────────────────────────────────────────────┤
│ <SideDrawer v-model="drawerOpen" ...>                      │
│                                                             │
│ // drawerOpen 被自动设置为 false                            │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ SideDrawer.vue                                              │
├─────────────────────────────────────────────────────────────┤
│ modelValue 变为 false                                       │
│                                                             │
│ // v-if="modelValue" 条件不满足                              │
│ // 整个 drawer-overlay 从 DOM 移除                          │
└─────────────────────────────────────────────────────────────┘
```

### 方式二：点击关闭按钮 (×)

```
用户点击 × 按钮
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ SideDrawer.vue                                              │
├─────────────────────────────────────────────────────────────┤
│ <button class="close-btn" @click="close">&times;</button>   │
│                                                             │
│ // 调用同一个 close() 函数                                  │
│ // 后续流程与方式一相同                                     │
└─────────────────────────────────────────────────────────────┘
```

### 方式三：点击表单"取消"按钮

```
用户点击取消按钮
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ CropForm.vue / AnimalForm.vue / FlowerForm.vue              │
├─────────────────────────────────────────────────────────────┤
│ <button type="button" @click="$emit('cancel')">            │
│   取消                                                       │
│ </button>                                                   │
└─────────────────────────────────────────────────────────────┘
    │
    │ $emit('cancel')
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 父组件 (CropsView.vue 等)                                   │
├─────────────────────────────────────────────────────────────┤
│ <SideDrawer v-model="drawerOpen" title="添加粮食">          │
│   <CropForm                                                 │
│     @cancel="drawerOpen = false"  // 直接设置为 false       │
│     @success="handleSuccess"                                │
│   />                                                        │
│ </SideDrawer>                                               │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ drawerOpen = false                                          │
│ // 抽屉关闭（后续流程与方式一相同）                         │
└─────────────────────────────────────────────────────────────┘
```

### 方式四：表单提交成功

```
用户填写表单并点击"保存"
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ CropForm.vue / AnimalForm.vue / FlowerForm.vue              │
├─────────────────────────────────────────────────────────────┤
│ async function handleSubmit() {                             │
│   // ... 验证和 API 调用 ...                                │
│   await cropsStore.createCrop(formData)                    │
│   emit('success')  // 发出成功事件                          │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
    │
    │ $emit('success')
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 父组件 (CropsView.vue 等)                                   │
├─────────────────────────────────────────────────────────────┤
│ <CropForm @success="handleSuccess" ... />                   │
│                                                             │
│ function handleSuccess() {                                  │
│   drawerOpen.value = false  // 关闭抽屉                     │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 抽屉关闭，列表自动刷新（新数据已通过 store.unshift 添加）   │
└─────────────────────────────────────────────────────────────┘
```

---

## 关闭方式对比

| 方式 | 触发位置 | 事件流向 | 备注 |
|------|----------|----------|------|
| 点击遮罩层 | `SideDrawer.vue` | `close()` → `emit('update:modelValue')` | 点击抽屉外部区域 |
| 点击 × 按钮 | `SideDrawer.vue` | `close()` → `emit('update:modelValue')` | 右上角关闭按钮 |
| 点击取消按钮 | `Form.vue` | `$emit('cancel')` → 父组件设置 `drawerOpen = false` | 表单内的取消操作 |
| 提交成功 | `Form.vue` | `$emit('success')` → 父组件调用 `handleSuccess()` | 保存成功后自动关闭 |

---

## 完整代码示例

### 父组件 (CropsView.vue)

```vue
<template>
  <main class="main">
    <!-- 添加按钮：设置 drawerOpen = true 打开抽屉 -->
    <div class="page-header">
      <h2>粮食管理</h2>
      <button class="btn btn-primary" @click="drawerOpen = true">
        添加粮食
      </button>
    </div>

    <!-- 表格内容... -->

    <!-- 侧边抽屉组件 -->
    <SideDrawer v-model="drawerOpen" title="添加粮食">
      <!-- 表单组件 -->
      <CropForm
        @success="handleSuccess"   <!-- 成功后关闭 -->
        @cancel="drawerOpen = false" <!-- 取消后关闭 -->
      />
    </SideDrawer>
  </main>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import SideDrawer from '@/components/common/SideDrawer.vue'
import CropForm from '@/components/forms/CropForm.vue'

// 控制抽屉开关的状态
const drawerOpen = ref(false)

// 表单提交成功后的处理
function handleSuccess() {
  drawerOpen.value = false  // 关闭抽屉
  // 新数据已通过 store.createCrop() 自动添加到列表
}
</script>
```

### 抽屉组件 (SideDrawer.vue)

```vue
<template>
  <!-- v-if 控制整个组件的渲染 -->
  <div v-if="modelValue" class="drawer-overlay" @click="close">
    <div
      class="drawer-container"
      :class="{ 'drawer-open': modelValue }"
      @click.stop  <!-- 阻止事件冒泡，避免点击抽屉内容时关闭 -->
    >
      <div class="drawer-header">
        <h3>{{ title }}</h3>
        <!-- 关闭按钮 -->
        <button class="close-btn" @click="close">&times;</button>
      </div>

      <div class="drawer-body">
        <slot></slot>  <!-- 插槽，放置表单 -->
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
interface Props {
  modelValue: boolean
  title?: string
}

const props = defineProps<Props>()

// 定义 emit，支持 v-model
const emit = defineEmits<{
  'update:modelValue': [value: boolean]
}>()

// 关闭抽屉的函数
function close() {
  emit('update:modelValue', false)  // 通知父组件更新状态
}
</script>

<style scoped>
.drawer-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
}

.drawer-container {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  width: 500px;
  max-width: 90vw;
  background: white;
  transform: translateX(100%);      /* 默认隐藏在右侧外部 */
  transition: transform 0.3s ease;  /* 300ms 滑动动画 */
}

.drawer-open {
  transform: translateX(0);  /* 滑入视图 */
}
</style>
```

### 表单组件 (CropForm.vue)

```vue
<template>
  <form @submit.prevent="handleSubmit">
    <!-- 表单字段... -->

    <div class="form-actions">
      <!-- 取消按钮：发出 cancel 事件 -->
      <button type="button" @click="$emit('cancel')">
        取消
      </button>

      <!-- 提交按钮 -->
      <button type="submit" :disabled="loading">
        {{ loading ? '保存中...' : '保存' }}
      </button>
    </div>
  </form>
</template>

<script setup lang="ts">
// 定义 emit 事件
const emit = defineEmits<{
  success: []  // 成功事件
  cancel: []   // 取消事件
}>()

async function handleSubmit() {
  // ... 验证 ...

  try {
    await cropsStore.createCrop(formData)
    emit('success')  // 成功后发出事件
  } catch (err) {
    // 错误处理...
  }
}
</script>
```

---

## Vue v-model 原理说明

Vue 3 的 `v-model` 是 `:modelValue` 和 `@update:modelValue` 的语法糖：

```vue
<!-- 以下两种写法等价 -->

<SideDrawer v-model="drawerOpen" />

<SideDrawer
  :modelValue="drawerOpen"
  @update:modelValue="newValue => drawerOpen = newValue"
/>
```

当子组件调用 `emit('update:modelValue', false)` 时：
1. 父组件接收到事件
2. Vue 自动将 `drawerOpen` 更新为 `false`
3. 新的 `modelValue` prop 传递回子组件
4. 子组件重新渲染，`v-if="modelValue"` 条件变为 false
5. 组件从 DOM 移除

---

## 注意事项

1. **事件冒泡处理**：抽屉容器使用 `@click.stop` 阻止点击事件冒泡到遮罩层，避免点击表单内容时误关闭

2. **条件渲染 vs 显示隐藏**：使用 `v-if` 而非 `v-show`，关闭时完全从 DOM 移除，节省资源

3. **动画时机**：由于 `v-if` 会销毁组件，动画通过 CSS `transition` 在元素存在期间完成

4. **状态管理**：`drawerOpen` 状态由父组件管理，子组件通过 emit 请求更新

---

## 总结

```
打开：父组件设置 drawerOpen = true → v-model 传递 → SideDrawer 渲染并滑出

关闭：
  1. 点击遮罩/×按钮 → SideDrawer emit → 父组件 drawerOpen = false
  2. 点击取消按钮 → Form emit('cancel') → 父组件 drawerOpen = false
  3. 提交成功 → Form emit('success') → 父组件 handleSuccess() → drawerOpen = false
```
